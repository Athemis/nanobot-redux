# Redux Changes

This file tracks changes that originate in this fork — not adopted from upstream, but developed here. It's a record of why decisions were made and how to verify them.

See [`docs/upstream-log.md`](upstream-log.md) for upstream adoptions.

## Changes

| Change | PR/Commit | Area | Why | Risk | Added | Verification |
| ------ | --------- | ---- | --- | ---- | ----- | ------------ |
| OpenClaw skill metadata regression tests | [9290f23](https://github.com/Athemis/nanobot-redux/commit/9290f23879df58cec39671b2cf984be23e1915fb) | Skills loader | Lock in fork behavior for `openclaw` metadata support and `nanobot` precedence when both keys exist | low | 2026-02-16 | `pytest tests/test_skills_loader.py` |
| Codex TLS verification hardening | [3d0d1eb](https://github.com/Athemis/nanobot-redux/commit/3d0d1ebdf2e711dce527b4b3ed2ddee2612734ca) | Codex Provider | Avoid silent TLS downgrade; require explicit `providers.openaiCodex.sslVerify=false` opt-in | low | 2026-02-16 | `pytest -q tests/test_config_loader_conversion.py tests/test_generation_params.py tests/test_onboard_openrouter_defaults.py` + `ruff check nanobot/config/schema.py nanobot/cli/commands.py nanobot/providers/openai_codex_provider.py` |
| Codex SSE error diagnostics | [2a77f20](https://github.com/Athemis/nanobot-redux/commit/2a77f20c2b91136ab9dabc11df063b4502dedc8d) | Codex Provider | Surface provider error details from `error`/`response.failed` payloads instead of generic failure text | low | 2026-02-16 | `pytest -q tests/test_generation_params.py` + `ruff check nanobot/providers/openai_codex_provider.py` |
| Codex OAuth token-limit compatibility | [#16](https://github.com/Athemis/nanobot-redux/pull/16), [#17](https://github.com/Athemis/nanobot-redux/issues/17) | Codex Provider | `chatgpt.com/backend-api/codex/responses` rejects unsupported token-limit parameters; align payload with OpenAI Codex OAuth request shape that omits `max_output_tokens`/`max_tokens` | low | 2026-02-17 | `pytest -q tests/test_generation_params.py -k codex` + `ruff check nanobot/providers/openai_codex_provider.py` |
| Email TLS verification hardening + plaintext SMTP block | [#6](https://github.com/Athemis/nanobot-redux/pull/6) | Email channel | Enforce explicit TLS verification by default with explicit opt-out warning (`channels.email.tlsVerify`), and refuse SMTP sends when both `smtpUseTls` and `smtpUseSsl` are disabled | medium | 2026-02-16 | `pytest -q tests/test_email_channel.py` + `ruff check nanobot/channels/email.py tests/test_email_channel.py nanobot/config/schema.py` |
| Subagent skill access in workspace-restricted mode | [#18](https://github.com/Athemis/nanobot-redux/pull/18) | Agent / Skills | Subagents couldn't read builtin skills when `restrictToWorkspace` was enabled; `ReadFileTool` gains `extra_allowed_dirs` allowlist so `BUILTIN_SKILLS_DIR` is always readable; subagent prompt updated to surface available skills | low | 2026-02-17 | `pytest -q tests/test_read_file_tool.py` + `ruff check nanobot/agent/subagent.py nanobot/agent/tools/filesystem.py` |
| Agentic prompt hardening | [#18](https://github.com/Athemis/nanobot-redux/pull/18) | Agent prompts | Skill-trigger wording, loop-continuation nudge, heartbeat prompt, spawn tool description, and workspace docs rewritten to push the agent toward direct action over passive confirmation-seeking | low | 2026-02-17 | `ruff check nanobot/agent/loop.py nanobot/agent/context.py nanobot/agent/tools/spawn.py nanobot/heartbeat/service.py` |
| CI lint enforcement | [e3128af](https://github.com/Athemis/nanobot-redux/commit/e3128af28bb7bccd455be70900152efc18379b44) | CI | `ruff check` failures now cause the test workflow to fail; previously lint errors were reported but did not block merges | low | 2026-02-16 | `.github/workflows/tests.yml` |
| Cron mtime hot-reload | [#22](https://github.com/Athemis/nanobot-redux/pull/22) | Cron service | `nanobot cron add` (CLI) writes only to disk; the running gateway never reloaded its in-memory store, so externally added jobs were silently skipped. Adds `_store_mtime` tracking, `_check_disk_changes()`, and a `_POLL_INTERVAL_S=300` cap on `_arm_timer` — fixes both the empty-store case (no timer at all) and the far-future-job case (timer would fire too late). No new dependencies. See rejected [HKUDS/nanobot#788](https://github.com/HKUDS/nanobot/pull/788) for the watchdog alternative. | low | 2026-02-18 | `pytest tests/test_cron_service.py` |
| Cron `_save_store` OSError resilience | [#22](https://github.com/Athemis/nanobot-redux/pull/22) | Cron service | `write_text()` or `stat()` in `_save_store` could raise `OSError` (disk full, permission error), propagating through `_on_timer` and killing the `tick()` asyncio task before `_arm_timer()` is called — permanently stopping the cron loop. Wraps both calls in `try/except OSError` with error logging; `_store_mtime` is only updated on success. | low | 2026-02-18 | `pytest tests/test_cron_service.py` |
| LiteLLM removal — OpenAIProvider replaces LiteLLMProvider | [#33](https://github.com/Athemis/nanobot-redux/pull/33) | Providers | Removes `litellm` dependency entirely; `OpenAIProvider` uses `openai.AsyncOpenAI` directly with `base_url` routing. All OpenAI-compatible providers (OpenRouter, DeepSeek, Zhipu, Moonshot, MiniMax, Groq, vLLM, AiHubMix, OpenAI) work without LiteLLM. Anthropic-native and Gemini-native support dropped — both are accessible via OpenRouter. `CustomProvider` absorbed into `OpenAIProvider` (same `_parse()` logic, adds registry-based routing). `ProviderSpec` fields `env_extras`, `skip_prefixes`, `is_direct` removed; `litellm_prefix` renamed to `model_prefix`. Breaking: `bedrock/` models no longer supported; `providers.anthropic`, `providers.gemini`, `providers.custom` config keys warn and are removed during migration. | low | 2026-02-18 | `grep -rE "import litellm\|LiteLLMProvider\|CustomProvider" nanobot/` (no output) + `pytest -q` + `ruff check nanobot/ tests/` |
| CI code coverage enforcement | [#42](https://github.com/Athemis/nanobot-redux/pull/42) | CI | `pytest` runs produce a `term-missing` coverage report and fail if total coverage of `nanobot/` drops below 63%; prevents silent test-gap regressions on every push and in CI without requiring changes to the workflow file | low | 2026-02-18 | `pytest -q` (last line: `Required test coverage of 63% reached`) |
| Test coverage expansion to 80% | [#43](https://github.com/Athemis/nanobot-redux/pull/43) | Tests / CI | 247 new tests across 19 new and extended test files; coverage threshold raised from 63% to 80%; covers memory, heartbeat, cron service/tool, bus, channels, filesystem tools, shell, MCP, transcription, config loader, subagent, web search, and CLI commands | low | 2026-02-19 | `pytest -q` (last line: `Required test coverage of 80% reached. Total coverage: 80.13%`) |
| OpenAI prompt caching controls in OpenAIProvider | [#49](https://github.com/Athemis/nanobot-redux/pull/49) | Providers / Config / CLI | Adds prompt-caching controls for `chat.completions` via `providers.*.promptCachingEnabled` and optional `promptCacheRetention`, with a provider-registry default that enables caching only for `openai` when unset; explicit config values still override defaults. `prompt_cache_key` is derived from stable runtime session IDs (`session_key` / subagent task id) and HMAC-SHA256 hashed (`v1:`-prefixed) before sending, avoiding per-request message-hash churn and raw identifier exposure. | low | 2026-02-19 | `pytest -q tests/test_generation_params.py tests/test_onboard_openrouter_defaults.py tests/test_config_loader_conversion.py` + `ruff check nanobot/agent/loop.py nanobot/agent/subagent.py nanobot/providers/base.py nanobot/providers/openai_provider.py nanobot/providers/openai_codex_provider.py nanobot/cli/commands.py nanobot/config/schema.py nanobot/providers/registry.py tests/test_generation_params.py tests/test_onboard_openrouter_defaults.py tests/test_config_loader_conversion.py` |
| Handle `keep_count == 0` consolidation slice correctly | [#68](https://github.com/Athemis/nanobot-redux/pull/68) | Agent loop | Prevent silent no-op consolidation when `memory_window < 2` by using an open-ended slice instead of `:0` | low | 2026-02-20 | `pytest -q tests/test_consolidate_offset.py --no-cov` + `ruff check nanobot/agent/loop.py tests/test_consolidate_offset.py` |
| Type annotate `session` in `_consolidate_memory` | [#66](https://github.com/Athemis/nanobot-redux/issues/66) | Agent loop | Align with fork typing rule requiring fully annotated function signatures | low | 2026-02-20 | `ruff check nanobot/agent/loop.py` + `pytest -q tests/test_consolidate_offset.py --no-cov` |
| Memory consolidation `/new`-guard + task-ref tracking | [#62](https://github.com/Athemis/nanobot-redux/pull/62) | Session memory | Fork-specific adaptations on top of upstream #823: (1) extend `_consolidating` sentinel to the `/new` command path so a concurrent `/new` cannot spawn a second simultaneous writer to `MEMORY.md`/`HISTORY.md`; (2) store all `asyncio.create_task()` return values in `_consolidation_tasks: set[asyncio.Task]` to prevent GC-before-completion, consistent with `subagent.py`/`cron`/`heartbeat`. | low | 2026-02-20 | `pytest -q tests/test_consolidate_offset.py` |
| `_bus_progress` default in `_process_message` | [b41409e](https://github.com/Athemis/nanobot-redux/commit/b41409e) + [67ab8d3](https://github.com/Athemis/nanobot-redux/commit/67ab8d3) | Agent loop | The fork's initial re-implementation of upstream #802 (`on_progress`) omitted the `_bus_progress` default callback. Without it, gateway users (Matrix, Email) received no intermediate tool-hint messages — the agent appeared to hang until the final response. `_process_message` now creates `_bus_progress` as default and passes `msg.metadata` through so Matrix thread-replies land in the correct thread. | low | 2026-02-20 | `pytest -q tests/test_on_progress.py` |
| Align `get_old_messages` test helper for `keep_count == 0` | [#70](https://github.com/Athemis/nanobot-redux/issues/70) | Tests | Keep test helper slicing consistent with production zero-keep behavior to avoid false negatives in future tests | low | 2026-02-20 | `pytest -q tests/test_consolidate_offset.py --no-cov` + `ruff check tests/test_consolidate_offset.py` |
| Bound consolidation watermark to pre-await snapshot length | [#63](https://github.com/Athemis/nanobot-redux/issues/63) | Agent loop | Prevent silent skipping of messages appended while memory consolidation awaits the LLM by advancing `last_consolidated` to the pre-await snapshot boundary instead of post-await session length | low | 2026-02-20 | `pytest -q tests/test_consolidate_offset.py::TestSnapshotWatermark::test_mid_flight_messages_not_skipped --no-cov` + `ruff check nanobot/agent/loop.py tests/test_consolidate_offset.py` |
| Upstream-style tool-hint progress formatting + optional Matrix filter | [#85](https://github.com/Athemis/nanobot-redux/pull/85) | Agent loop / Matrix UX | Align `_tool_hint` output with upstream style (`tool("arg")`) and add optional Matrix-only suppression via `channels.matrix.filterProgressToolHints` for progress-only tool hints | low | 2026-02-20 | `pytest --no-cov -q tests/test_on_progress.py` + `ruff check nanobot/agent/loop.py nanobot/channels/matrix.py nanobot/config/schema.py tests/test_on_progress.py` |
| Matrix tool-call progress visibility option | [#96](https://github.com/Athemis/nanobot-redux/pull/96) | Matrix channel / Agent loop | Add explicit Matrix config to show or hide tool-call progress hints and switch filtering to structured `_progress_kind` metadata instead of regex text inference | low | 2026-02-21 | `pytest --no-cov -q tests/test_on_progress.py tests/test_matrix_channel.py` + `ruff check nanobot/agent/loop.py nanobot/channels/matrix.py nanobot/config/schema.py tests/test_on_progress.py tests/test_matrix_channel.py` |
| Avoid empty Matrix/Email fallbacks when message tool already replied | [#87](https://github.com/Athemis/nanobot-redux/pull/87) | Agent loop / Matrix delivery | Prevents blank `m.room.message` events after attachment sends by keeping empty sentinel outbound only for `cli` turn-completion and skipping it for non-CLI channels | low | 2026-02-21 | `pytest --no-cov tests/test_on_progress.py::test_run_always_publishes_outbound_for_none_response tests/test_on_progress.py::test_run_skips_empty_sentinel_for_non_cli_channels -v` + `pytest --no-cov tests/test_matrix_channel.py::test_send_uploads_media_and_sends_file_event -v` + `ruff check nanobot/agent/loop.py tests/test_on_progress.py` |

### Template for New Entries

```markdown
| Description | [#N](https://github.com/Athemis/nanobot-redux/pull/N) or [abc1234](https://github.com/Athemis/nanobot-redux/commit/abc1234) | Area | Why | low | YYYY-MM-DD | `pytest tests/...` |
```

**Columns:**

- **Change**: Short description of what changed
- **PR/Commit**: Link to the PR or the key implementation commit in this fork
- **Area**: What part of the codebase (Codex Provider, Email channel, CI, etc.)
- **Why**: Rationale — what problem it solves or what invariant it enforces
- **Risk**: `low`, `medium`, or `high` — maintenance/security assessment
- **Added**: Date merged into `main` (YYYY-MM-DD)
- **Verification**: How to verify it works

## Notes

- **Not everything is logged**: Minor docs tweaks, workspace content edits, and style-only changes don't get entries.
- **Dates are merge dates**: When the change landed in `main`, not when it was authored.
- **Risk is subjective**: Assessed for maintenance burden and security impact.

## Related Documentation

- [`docs/upstream-log.md`](upstream-log.md) - Upstream adoptions, deferrals, and rejections
- [`docs/redux-manifest.md`](redux-manifest.md) - Fork philosophy and priorities
- [`docs/upstream-intake.md`](upstream-intake.md) - How upstream changes are evaluated
- [`docs/release-template.md`](release-template.md) - Release checklist
